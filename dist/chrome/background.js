(()=>{"use strict";function e(){if("undefined"!=typeof browser)try{return browser.runtime.getBrowserInfo?"firefox":"chrome"}catch{return"chrome"}return"chrome"}"undefined"!=typeof browser?browser:chrome,new Map,chrome.runtime.onMessage.addListener(((e,r,t)=>{if("sendToAPI"===e.action)return async function(e){try{const r=new URLSearchParams({userChatQuery:`${e.context}\n\n${e.question}`}),t=await fetch(`http://localhost:8000/chat/query?${r.toString()}`,{method:"GET",headers:{"Content-Type":"application/json"}}),o=await t.json();if(!t.ok)throw new Error(o.detail||"Failed to fetch response");return{success:!0,message:o.response}}catch(e){return{success:!1,error:e.message||"API request failed"}}}(e.content).then(t).catch((e=>t({success:!1,error:e.message}))),!0})),chrome.storage.onChanged.addListener(((e,r)=>{"sync"===r&&chrome.tabs.query({},(r=>{r.forEach((r=>{try{chrome.tabs.sendMessage(r.id,{action:"settingsUpdated",changes:e})}catch(e){console.debug("Could not send to tab:",r.id)}}))}))})),chrome.action.onClicked.addListener((async r=>{if(!r.url.startsWith("chrome://")&&!r.url.startsWith("about:"))try{await async function(r){if("firefox"!==e())return chrome.sidePanel.open({tabId:r.id});try{await browser.sidebarAction.close(),await new Promise((e=>setTimeout(e,250))),await browser.sidebarAction.open()}catch(e){return console.error("Sidebar error:",e),browser.windows.create({url:"popup.html",type:"popup",width:400,height:600})}}(r)}catch(e){console.error("Failed to open panel:",e),chrome.windows.create({url:"popup.html",type:"popup",width:400,height:600})}})),"firefox"===e()&&(browser.browserAction.onClicked.addListener((async()=>{try{const e=await browser.windows.getCurrent();await browser.sidebarAction.close(),await new Promise((e=>setTimeout(e,250))),await browser.sidebarAction.open({windowId:e.id})}catch(e){console.error("Failed to toggle sidebar:",e),browser.windows.create({url:"popup.html",type:"popup",width:400,height:600})}})),browser.runtime.onInstalled.addListener((()=>{browser.sidebarAction.open()})))})();